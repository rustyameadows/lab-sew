<main class="builder">
  <header class="builder__header">
  </header>

  <% params_snapshot = (@design_session.params_snapshot || {}).deep_stringify_keys %>
  <% if params_snapshot["pocket"].is_a?(Hash) %>
    <% params_snapshot["pocket_enabled"] ||= params_snapshot["pocket"]["enabled"] %>
    <% params_snapshot["pocket_placement"] ||= params_snapshot["pocket"]["placement"] %>
  <% end %>
  <% assembly = @design_session.assembly_definition %>
  <% definition = assembly&.definition_json || {} %>
  <% parameters = Array(definition["parameters"]) %>
  <% panels = Array(definition["panels"]) %>
  <% default_values = parameters.each_with_object({}) do |param, acc| %>
    <% acc[param["key"]] = param["default"] if param.key?("default") %>
  <% end %>
  <% params_snapshot = default_values.merge(params_snapshot) %>
  <% grouped_params = parameters.group_by { |param| param["group"].presence || "Options" } %>
  <% assembly_selected = assembly.present? %>

  <section class="builder__layout">
    <section
      class="builder__preview"
      aria-label="Preview"
      data-controller="preview-3d"
      data-preview-3d-geometry-url-value="<%= design_session_geometry_path(@design_session.uuid) %>"
    >
      <h2>Preview</h2>
      <div class="preview__links">
        <%= link_to "Debug JSON", design_session_geometry_path(@design_session.uuid), class: "builder__link" %>
        <%= link_to "Preview SVG", design_session_preview_path(@design_session.uuid, format: :svg),
          class: "builder__link",
          data: { preview_svg_link: true } %>
        <button type="button" class="builder__link" data-action="preview-3d#toggle">Toggle 3D</button>
      </div>
      <div
        class="preview__canvas"
        role="img"
        aria-label="3D preview"
      >
        <% if assembly_selected %>
          <canvas class="preview__three" data-preview-3d-target="canvas"></canvas>
        <% else %>
          <span>Select an assembly to preview panels.</span>
        <% end %>
      </div>
    </section>

    <aside class="builder__options" aria-label="Options">
      <h2>Options</h2>

      <div class="options__assembly">
        <label>
          Assembly
          <select
            name="assembly_definition_id"
            data-controller="design-session-assembly"
            data-design-session-assembly-uuid-value="<%= @design_session.uuid %>"
            data-action="change->design-session-assembly#save"
          >
            <option value="">Select assembly</option>
            <% @assemblies.each do |assembly| %>
              <option value="<%= assembly.id %>" <%= "selected" if @design_session.assembly_definition_id == assembly.id %>>
                <%= assembly.name %>
              </option>
            <% end %>
          </select>
        </label>
        <%= link_to "Manage assemblies", assemblies_path, class: "builder__link" %>
      </div>

      <% if assembly_selected %>
        <% if parameters.any? %>
          <form
            class="options__form"
            data-controller="design-session-params"
            data-design-session-params-uuid-value="<%= @design_session.uuid %>"
            data-action="input->design-session-params#queueSave change->design-session-params#queueSave"
          >
            <% grouped_params.each do |group, group_params| %>
              <fieldset>
                <legend><%= group %></legend>
                <% group_params.each do |param| %>
                  <% key = param["key"] %>
                  <% label = param["label"] || key.to_s.humanize %>
                  <% type = param["type"] || "text" %>
                  <% value = params_snapshot[key] %>

                  <% if type == "number" %>
                    <label>
                      <%= label %>
                      <input
                        type="number"
                        step="0.1"
                        name="<%= key %>"
                        value="<%= value %>"
                        data-param-key="<%= key %>"
                        data-param-type="number"
                      />
                    </label>
                  <% elsif type == "select" %>
                    <label>
                      <%= label %>
                      <select name="<%= key %>" data-param-key="<%= key %>" data-param-type="select">
                        <% Array(param["options"]).each do |option| %>
                          <% option_value = option["value"] %>
                          <% option_label = option["label"] || option_value %>
                          <option value="<%= option_value %>" <%= "selected" if value.to_s == option_value.to_s %>>
                            <%= option_label %>
                          </option>
                        <% end %>
                      </select>
                    </label>
                  <% elsif type == "multiselect" %>
                    <div class="options__toggle-group" role="group" aria-label="<%= label %>">
                      <% Array(param["options"]).each do |option| %>
                        <% option_value = option["value"] %>
                        <% option_label = option["label"] || option_value %>
                        <label>
                          <input
                            type="checkbox"
                            name="<%= key %>[]"
                            value="<%= option_value %>"
                            data-param-key="<%= key %>"
                            data-param-type="multiselect"
                            <%= "checked" if Array(value).map(&:to_s).include?(option_value.to_s) %>
                          />
                          <%= option_label %>
                        </label>
                      <% end %>
                    </div>
                  <% elsif type == "checkbox" %>
                    <label>
                      <input
                        type="checkbox"
                        name="<%= key %>"
                        data-param-key="<%= key %>"
                        data-param-type="checkbox"
                        <%= "checked" if value %>
                      />
                      <%= label %>
                    </label>
                  <% else %>
                    <label>
                      <%= label %>
                      <input
                        type="text"
                        name="<%= key %>"
                        value="<%= value %>"
                        data-param-key="<%= key %>"
                        data-param-type="text"
                      />
                    </label>
                  <% end %>
                <% end %>
              </fieldset>
            <% end %>
          </form>
        <% else %>
          <p>Options for this assembly are not defined yet.</p>
        <% end %>
      <% else %>
        <p>Select an assembly to configure options.</p>
      <% end %>
    </aside>

    <section class="builder__panels" aria-label="Panels">
      <h2>Panels</h2>
      <div class="panels__strip">
        <% if panels.any? %>
          <% panels.each do |panel| %>
            <div class="panel__thumb">
              <img
                class="panel__svg"
                src="<%= design_session_preview_path(@design_session.uuid, format: :svg, panel: panel["key"], scale: 8) %>"
                alt="<%= panel["label"] || panel["key"] %> panel preview"
                data-panel-preview="<%= panel["key"] %>"
              />
              <span><%= panel["label"] || panel["key"] %></span>
            </div>
          <% end %>
        <% else %>
          <div class="panel__thumb">No panels yet</div>
        <% end %>
      </div>
    </section>

    <aside class="builder__export" aria-label="Export">
      <h2>Export</h2>
      <form class="export__form">
        <label>
          Project name
          <input
            type="text"
            name="project_name"
            placeholder="Untitled project"
            value="<%= @design_session.name %>"
            data-controller="design-session-name"
            data-design-session-name-uuid-value="<%= @design_session.uuid %>"
            data-action="input->design-session-name#queueSave"
          />
        </label>
        <div class="export__actions">
          <button type="button">Download packet</button>
          <button type="button">Share</button>
        </div>
      </form>
    </aside>
  </section>

  <footer class="builder__footer">
    <%= link_to "Back to projects", projects_path, class: "builder__link" %>
    <%= button_to "Delete project", project_path(@design_session.uuid),
      method: :delete,
      data: { turbo_confirm: "Delete this project?" } %>
  </footer>
</main>
